import React, { useEffect, useMemo, useState } from 'react';
import styles from './Dashboard.module.css';
import api from '../../lib/api.js';
import { Bar } from 'react-chartjs-2';
import {
  Chart as ChartJS,
  CategoryScale,
  LinearScale,
  BarElement,
  Tooltip,
} from 'chart.js';

ChartJS.register(CategoryScale, LinearScale, BarElement, Tooltip);

function Breadcrumbs() {
  return (
    <div className={styles.breadcrumbs}>
      <span className={styles.bcMuted}>Home</span>
      <span className={styles.bcSep}>&gt;</span>
      <span className={styles.bcBold}>Dashboard</span>
    </div>
  );
}

function IconWrap({ children }) {
  return <div className={styles.kpiIcon}>{children}</div>;
}

function KpiCard({ title, value, icon }) {
  return (
    <div className={styles.kpiCard}>
      <div className={styles.kpiLeft}>
        <IconWrap>{icon}</IconWrap>
        <div className={styles.kpiText}>
          <div className={styles.kpiTitle}>{title}</div>
          <div className={styles.kpiValue}>{value}</div>
        </div>
      </div>
    </div>
  );
}

function InitialsAvatar({ firstName, lastName }) {
  const a = (firstName?.[0] || '').toUpperCase();
  const b = (lastName?.[0] || '').toUpperCase();
  return <div className={styles.avatar}>{a}{b}</div>;
}

export default function Dashboard() {
  const [data, setData] = useState(null);
  const [teamSearch, setTeamSearch] = useState('');

  useEffect(() => {
    api.get('/api/admin/dashboard').then(r => setData(r.data));
  }, []);

  const filteredEmployees = useMemo(() => {
    const items = data?.activeEmployees || [];
    if (!teamSearch.trim()) return items;
    const q = teamSearch.trim().toLowerCase();
    return items.filter(e => {
      const full = `${e.firstName} ${e.lastName}`.toLowerCase();
      return full.includes(q)
        || (e.email || '').toLowerCase().includes(q)
        || (e.employeeID || '').toLowerCase().includes(q);
    });
  }, [data, teamSearch]);

  const chart = useMemo(() => {
    const rows = data?.analyticsWeek || [];
    const labels = rows.map(r => r.day);
    const values = rows.map(r => r.rate);
    const max = values.reduce((m, v) => Math.max(m, v), 0);
    const suggestedMax = Math.max(60, Math.ceil(max / 10) * 10);
    return {
      labels,
      values,
      suggestedMax,
      data: {
        labels,
        datasets: [{
          label: 'Conversion Rate (%)',
          data: values,
          backgroundColor: '#d8d8d8',
          borderRadius: 10,
          barThickness: 22,
        }]
      }
    };
  }, [data]);

  const relative = (iso) => {
    const t = new Date(iso).getTime();
    const now = Date.now();
    let diff = Math.max(0, Math.floor((now - t) / 1000));
    const mins = Math.floor(diff / 60);
    if (mins < 1) return 'just now';
    if (mins < 60) return `${mins} min ago`;
    const hrs = Math.floor(mins / 60);
    if (hrs < 24) return `${hrs} hour${hrs === 1 ? '' : 's'} ago`;
    const days = Math.floor(hrs / 24);
    return `${days} day${days === 1 ? '' : 's'} ago`;
  };

  return (
    <div className={styles.page}>
      <div className={styles.headerBar}>
        <div className={styles.searchWrap}>
          <div className={styles.searchIcon} aria-hidden="true">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M10.5 18C14.6421 18 18 14.6421 18 10.5C18 6.35786 14.6421 3 10.5 3C6.35786 3 3 6.35786 3 10.5C3 14.6421 6.35786 18 10.5 18Z" stroke="#5B5B5B" strokeWidth="2"/>
              <path d="M16.5 16.5L21 21" stroke="#5B5B5B" strokeWidth="2" strokeLinecap="round"/>
            </svg>
          </div>
          <input
            className={styles.search}
            placeholder="Search here..."
            value={teamSearch}
            onChange={e => setTeamSearch(e.target.value)}
          />
        </div>
      </div>

      <div className={styles.content}>
      <Breadcrumbs />

      <div className={styles.kpiRow}>
        <KpiCard
          title="Unassigned Leads"
          value={data?.cards?.unassignedLeads ?? '—'}
          icon={
            <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="16" cy="16" r="16" fill="#ECECEC"/>
              <path d="M17.8333 16.917C17.0694 16.917 16.4201 16.6496 15.8854 16.1149C15.3507 15.5802 15.0833 14.9309 15.0833 14.167C15.0833 13.4031 15.3507 12.7538 15.8854 12.2191C16.4201 11.6844 17.0694 11.417 17.8333 11.417C18.5972 11.417 19.2465 11.6844 19.7812 12.2191C20.3159 12.7538 20.5833 13.4031 20.5833 14.167C20.5833 14.9309 20.3159 15.5802 19.7812 16.1149C19.2465 16.6496 18.5972 16.917 17.8333 16.917ZM11.4166 19.667C10.9125 19.667 10.4809 19.4875 10.1218 19.1285C9.76281 18.7694 9.58329 18.3378 9.58329 17.8337V10.5003C9.58329 9.99616 9.76281 9.56456 10.1218 9.20553C10.4809 8.84651 10.9125 8.66699 11.4166 8.66699H24.25C24.7541 8.66699 25.1857 8.84651 25.5448 9.20553C25.9038 9.56456 26.0833 9.99616 26.0833 10.5003V17.8337C26.0833 18.3378 25.9038 18.7694 25.5448 19.1285C25.1857 19.4875 24.7541 19.667 24.25 19.667H11.4166ZM13.25 17.8337H22.4166C22.4166 17.3295 22.5961 16.8979 22.9552 16.5389C23.3142 16.1798 23.7458 16.0003 24.25 16.0003V12.3337C23.7458 12.3337 23.3142 12.1541 22.9552 11.7951C22.5961 11.4361 22.4166 11.0045 22.4166 10.5003H13.25C13.25 11.0045 13.0704 11.4361 12.7114 11.7951C12.3524 12.1541 11.9208 12.3337 11.4166 12.3337V16.0003C11.9208 16.0003 12.3524 16.1798 12.7114 16.5389C13.0704 16.8979 13.25 17.3295 13.25 17.8337ZM23.3333 23.3337H7.74996C7.24579 23.3337 6.8142 23.1541 6.45517 22.7951C6.09614 22.4361 5.91663 22.0045 5.91663 21.5003V11.417H7.74996V21.5003H23.3333V23.3337Z" fill="#616161"/>
            </svg>
          }
        />
        <KpiCard
          title="Assigned This Week"
          value={data?.cards?.assignedThisWeek ?? '—'}
          icon={
            <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="16" cy="16" r="16" fill="#ECECEC"/>
              <path d="M16 16.0003C14.9916 16.0003 14.1284 15.6413 13.4104 14.9232C12.6923 14.2052 12.3333 13.342 12.3333 12.3337C12.3333 11.3253 12.6923 10.4621 13.4104 9.74408C14.1284 9.02602 14.9916 8.66699 16 8.66699C17.0083 8.66699 17.8715 9.02602 18.5895 9.74408C19.3076 10.4621 19.6666 11.3253 19.6666 12.3337C19.6666 13.342 19.3076 14.2052 18.5895 14.9232C17.8715 15.6413 17.0083 16.0003 16 16.0003ZM8.66663 23.3337V20.767C8.66663 20.2475 8.80031 19.7701 9.06767 19.3347C9.33503 18.8993 9.69024 18.567 10.1333 18.3378C11.0805 17.8642 12.043 17.509 13.0208 17.2722C13.9986 17.0354 14.9916 16.917 16 16.917C17.0083 16.917 18.0013 17.0354 18.9791 17.2722C19.9569 17.509 20.9194 17.8642 21.8666 18.3378C22.3097 18.567 22.6649 18.8993 22.9323 19.3347C23.1996 19.7701 23.3333 20.2475 23.3333 20.767V23.3337H8.66663ZM10.5 21.5003H21.5V20.767C21.5 20.5989 21.4579 20.4462 21.3739 20.3087C21.2899 20.1712 21.1791 20.0642 21.0416 19.9878C20.2166 19.5753 19.384 19.266 18.5437 19.0597C17.7034 18.8535 16.8555 18.7503 16 18.7503C15.1444 18.7503 14.2965 18.8535 13.4562 19.0597C12.6159 19.266 11.7833 19.5753 10.9583 19.9878C10.8208 20.0642 10.71 20.1712 10.626 20.3087C10.542 20.4462 10.5 20.5989 10.5 20.767V21.5003ZM16 14.167C16.5041 14.167 16.9357 13.9875 17.2948 13.6285C17.6538 13.2694 17.8333 12.8378 17.8333 12.3337C17.8333 11.8295 17.6538 11.3979 17.2948 11.0389C16.9357 10.6798 16.5041 10.5003 16 10.5003C15.4958 10.5003 15.0642 10.6798 14.7052 11.0389C14.3461 11.3979 14.1666 11.8295 14.1666 12.3337C14.1666 12.8378 14.3461 13.2694 14.7052 13.6285C15.0642 13.9875 15.4958 14.167 16 14.167Z" fill="#616161"/>
            </svg>
          }
        />
        <KpiCard
          title="Active Salespeople"
          value={data?.cards?.activeSalespeople ?? '—'}
          icon={
            <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="16" cy="16" r="16" fill="#ECECEC"/>
              <path d="M15.8854 23.333C15.9465 23.333 16.0076 23.3177 16.0687 23.2872C16.1298 23.2566 16.1757 23.2261 16.2062 23.1955L23.7229 15.6788C23.9062 15.4955 24.0399 15.2893 24.1239 15.0601C24.208 14.8309 24.25 14.6018 24.25 14.3726C24.25 14.1281 24.208 13.8952 24.1239 13.6736C24.0399 13.4521 23.9062 13.2573 23.7229 13.0893L19.8271 9.19342C19.659 9.01009 19.4642 8.87641 19.2427 8.79238C19.0212 8.70836 18.7882 8.66634 18.5437 8.66634C18.3146 8.66634 18.0854 8.70836 17.8562 8.79238C17.6271 8.87641 17.4208 9.01009 17.2375 9.19342L16.9854 9.44551L18.6812 11.1643C18.9104 11.3781 19.0784 11.6226 19.1854 11.8976C19.2923 12.1726 19.3458 12.4629 19.3458 12.7684C19.3458 13.4101 19.1281 13.9486 18.6927 14.384C18.2573 14.8195 17.7187 15.0372 17.0771 15.0372C16.7715 15.0372 16.4774 14.9837 16.1948 14.8768C15.9121 14.7698 15.6639 14.6094 15.45 14.3955L13.7312 12.6997L9.7208 16.7101C9.67497 16.7559 9.6406 16.8056 9.61768 16.859C9.59476 16.9125 9.5833 16.9698 9.5833 17.0309C9.5833 17.1531 9.62914 17.2639 9.7208 17.3632C9.81247 17.4625 9.91941 17.5122 10.0416 17.5122C10.1027 17.5122 10.1639 17.4969 10.225 17.4663C10.2861 17.4358 10.3319 17.4052 10.3625 17.3747L13.4791 14.258L14.7625 15.5413L11.6687 18.658C11.6229 18.7038 11.5885 18.7535 11.5656 18.807C11.5427 18.8604 11.5312 18.9177 11.5312 18.9788C11.5312 19.1011 11.5771 19.208 11.6687 19.2997C11.7604 19.3913 11.8673 19.4372 11.9896 19.4372C12.0507 19.4372 12.1118 19.4219 12.1729 19.3913C12.234 19.3608 12.2798 19.3302 12.3104 19.2997L15.4271 16.2059L16.7104 17.4893L13.6166 20.6059C13.5708 20.6365 13.5364 20.6823 13.5135 20.7434C13.4906 20.8045 13.4791 20.8656 13.4791 20.9268C13.4791 21.049 13.525 21.1559 13.6166 21.2476C13.7083 21.3393 13.8152 21.3851 13.9375 21.3851C13.9986 21.3851 14.0559 21.3736 14.1093 21.3507C14.1628 21.3278 14.2125 21.2934 14.2583 21.2476L17.375 18.1538L18.6583 19.4372L15.5416 22.5538C15.4958 22.5997 15.4614 22.6493 15.4385 22.7028C15.4156 22.7563 15.4041 22.8136 15.4041 22.8747C15.4041 22.9969 15.4538 23.1038 15.5531 23.1955C15.6524 23.2872 15.7632 23.333 15.8854 23.333ZM15.8625 25.1663C15.2972 25.1663 14.7968 24.9792 14.3614 24.6049C13.926 24.2306 13.6701 23.7608 13.5937 23.1955C13.0743 23.1191 12.6389 22.9052 12.2875 22.5538C11.9361 22.2025 11.7222 21.767 11.6458 21.2476C11.1264 21.1712 10.6948 20.9535 10.351 20.5945C10.0073 20.2354 9.79719 19.8038 9.7208 19.2997C9.14025 19.2233 8.66664 18.9712 8.29997 18.5434C7.9333 18.1156 7.74997 17.6115 7.74997 17.0309C7.74997 16.7254 7.80726 16.4313 7.92185 16.1486C8.03643 15.866 8.20066 15.6177 8.41455 15.4038L13.7312 10.1101L16.7333 13.1122C16.7639 13.158 16.8097 13.1924 16.8708 13.2153C16.9319 13.2382 16.993 13.2497 17.0541 13.2497C17.1916 13.2497 17.3062 13.2077 17.3979 13.1236C17.4896 13.0396 17.5354 12.9288 17.5354 12.7913C17.5354 12.7302 17.5239 12.6691 17.501 12.608C17.4781 12.5469 17.4437 12.5011 17.3979 12.4705L14.1208 9.19342C13.9527 9.01009 13.758 8.87641 13.5364 8.79238C13.3149 8.70836 13.0819 8.66634 12.8375 8.66634C12.6083 8.66634 12.3791 8.70836 12.15 8.79238C11.9208 8.87641 11.7146 9.01009 11.5312 9.19342L8.29997 12.4476C8.16247 12.5851 8.04789 12.7455 7.95622 12.9288C7.86455 13.1122 7.80344 13.2955 7.77289 13.4788C7.74233 13.6622 7.74233 13.8493 7.77289 14.0403C7.80344 14.2313 7.86455 14.4108 7.95622 14.5788L6.62705 15.908C6.36733 15.5566 6.17636 15.1709 6.05414 14.7507C5.93192 14.3306 5.88608 13.9066 5.91664 13.4788C5.94719 13.0511 6.05414 12.6347 6.23747 12.2299C6.4208 11.825 6.67289 11.4622 6.99372 11.1413L10.225 7.91009C10.5916 7.5587 11.0003 7.29134 11.451 7.10801C11.9017 6.92467 12.3639 6.83301 12.8375 6.83301C13.3111 6.83301 13.7732 6.92467 14.2239 7.10801C14.6746 7.29134 15.0757 7.5587 15.4271 7.91009L15.6791 8.16217L15.9312 7.91009C16.2979 7.5587 16.7066 7.29134 17.1573 7.10801C17.608 6.92467 18.0701 6.83301 18.5437 6.83301C19.0173 6.83301 19.4795 6.92467 19.9302 7.10801C20.3809 7.29134 20.7819 7.5587 21.1333 7.91009L25.0062 11.783C25.3576 12.1344 25.625 12.5393 25.8083 12.9976C25.9916 13.4559 26.0833 13.9219 26.0833 14.3955C26.0833 14.8691 25.9916 15.3313 25.8083 15.782C25.625 16.2327 25.3576 16.6337 25.0062 16.9851L17.4896 24.4788C17.2757 24.6927 17.0274 24.8608 16.7448 24.983C16.4621 25.1052 16.168 25.1663 15.8625 25.1663Z" fill="#616161"/>
            </svg>
          }
        />
        <KpiCard
          title="Conversion Rate"
          value={`${data?.cards?.conversionRate ?? '—'}%`}
          icon={
            <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="16" cy="16" r="16" fill="#ECECEC"/>
              <path d="M11.7605 24.2729C11.2105 24.2576 10.6872 24.1163 10.1907 23.849C9.69414 23.5816 9.22435 23.1882 8.78129 22.6688C8.17018 21.9354 7.69275 21.0608 7.349 20.0448C7.00525 19.0288 6.83337 17.9861 6.83337 16.9167C6.83337 15.6486 7.074 14.4569 7.55525 13.3417C8.0365 12.2264 8.68962 11.2563 9.51462 10.4313C10.3396 9.60625 11.3098 8.95312 12.425 8.47188C13.5403 7.99063 14.732 7.75 16 7.75C17.2681 7.75 18.4598 7.99444 19.575 8.48333C20.6903 8.97222 21.6605 9.63681 22.4855 10.4771C23.3105 11.3174 23.9636 12.3028 24.4448 13.4333C24.9261 14.5639 25.1667 15.7785 25.1667 17.0771C25.1667 18.2535 24.9757 19.3535 24.5938 20.3771C24.2118 21.4007 23.6695 22.2639 22.9667 22.9667C22.5389 23.3944 22.0882 23.7191 21.6146 23.9406C21.141 24.1622 20.6598 24.2729 20.1709 24.2729C19.8959 24.2729 19.6209 24.2385 19.3459 24.1698C19.0709 24.101 18.7959 23.9979 18.5209 23.8604L17.2375 23.2188C17.0542 23.1271 16.8594 23.0583 16.6532 23.0125C16.4469 22.9667 16.2292 22.9438 16 22.9438C15.7709 22.9438 15.5532 22.9667 15.3469 23.0125C15.1407 23.0583 14.9459 23.1271 14.7625 23.2188L13.4792 23.8604C13.1889 24.0132 12.9025 24.124 12.6198 24.1927C12.3372 24.2615 12.0507 24.2882 11.7605 24.2729ZM11.8063 22.4396C11.9438 22.4396 12.0851 22.4243 12.2302 22.3938C12.3754 22.3632 12.5167 22.3097 12.6542 22.2333L13.9375 21.5917C14.2584 21.4236 14.5907 21.3014 14.9344 21.225C15.2782 21.1486 15.6257 21.1104 15.9771 21.1104C16.3285 21.1104 16.6799 21.1486 17.0313 21.225C17.3827 21.3014 17.7188 21.4236 18.0396 21.5917L19.3459 22.2333C19.4834 22.3097 19.6209 22.3632 19.7584 22.3938C19.8959 22.4243 20.0334 22.4396 20.1709 22.4396C20.4612 22.4396 20.7362 22.3632 20.9959 22.2104C21.2556 22.0576 21.5153 21.8285 21.775 21.5229C22.2639 20.9424 22.6459 20.2472 22.9209 19.4375C23.1959 18.6278 23.3334 17.7951 23.3334 16.9396C23.3334 14.8924 22.623 13.1545 21.2021 11.726C19.7813 10.2976 18.0473 9.58333 16 9.58333C13.9528 9.58333 12.2188 10.3014 10.798 11.7375C9.37712 13.1736 8.66671 14.9153 8.66671 16.9625C8.66671 17.8333 8.80803 18.6813 9.09067 19.5063C9.3733 20.3313 9.76671 21.0264 10.2709 21.5917C10.5306 21.8972 10.7827 22.1149 11.0271 22.2448C11.2716 22.3747 11.5313 22.4396 11.8063 22.4396ZM16 18.75C16.5042 18.75 16.9358 18.5705 17.2948 18.2115C17.6539 17.8524 17.8334 17.4208 17.8334 16.9167C17.8334 16.7944 17.8219 16.6722 17.799 16.55C17.7761 16.4278 17.7417 16.3056 17.6959 16.1833L18.8417 14.6479C18.9945 14.8465 19.1282 15.0566 19.2427 15.2781C19.3573 15.4997 19.4528 15.7403 19.5292 16H21.4084C21.1792 14.6556 20.5566 13.5556 19.5407 12.7C18.5247 11.8444 17.3445 11.4167 16 11.4167C14.6556 11.4167 13.4716 11.8483 12.448 12.7115C11.4243 13.5747 10.8056 14.6708 10.5917 16H12.4709C12.6848 15.175 13.1202 14.5104 13.7771 14.0062C14.4341 13.5021 15.175 13.25 16 13.25C16.2598 13.25 16.5042 13.2729 16.7334 13.3187C16.9625 13.3646 17.1841 13.4333 17.398 13.525L16.2292 15.1063C16.1987 15.1063 16.1605 15.1024 16.1146 15.0948C16.0688 15.0872 16.0306 15.0833 16 15.0833C15.4959 15.0833 15.0643 15.2628 14.7052 15.6219C14.3462 15.9809 14.1667 16.4125 14.1667 16.9167C14.1667 17.4208 14.3462 17.8524 14.7052 18.2115C15.0643 18.5705 15.4959 18.75 16 18.75Z" fill="#616161"/>
            </svg>
          }
        />
      </div>

      <div className={styles.midRow}>
        <div className={styles.chartCard}>
          <div className={styles.sectionTitle}>Sale Analytics</div>
          <div className={styles.chartArea}>
            {data ? (
              <Bar
                data={chart.data}
                options={{
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: { legend: { display: false } },
                  scales: {
                    y: {
                      min: 0,
                      max: chart.suggestedMax,
                      ticks: { stepSize: 10, callback: (v) => `${v}%` },
                      grid: { color: 'rgba(0,0,0,0.08)', borderDash: [4, 4] }
                    },
                    x: { grid: { display: false } }
                  }
                }}
              />
            ) : null}
          </div>
        </div>

        <div className={styles.activityCard}>
          <div className={styles.sectionTitle}>Recent Activity Feed</div>
          <div className={styles.activityList}>
            {(data?.recentActivities || []).map((a) => (
              <div className={styles.activityItem} key={a._id}>
                <div className={styles.activityText}>• {a.message}</div>
                <div className={styles.activityTime}>— {relative(a.createdAt)}</div>
              </div>
            ))}
          </div>
        </div>
      </div>

      <div className={styles.tableCard}>
        <div className={styles.sectionTitle}>Active Sales People</div>

        <div className={styles.tableHead}>
          <div>Name</div>
          <div>Employee ID</div>
          <div>Assigned Leads</div>
          <div>Closed Leads</div>
          <div>Status</div>
        </div>

        <div className={styles.tableBody}>
          {filteredEmployees.map((e) => (
            <div className={styles.row} key={e.id}>
              <div className={styles.nameCell}>
                <InitialsAvatar firstName={e.firstName} lastName={e.lastName} />
                <div>
                  <div className={styles.name}>{e.firstName} {e.lastName}</div>
                  <div className={styles.email}>{e.email}</div>
                </div>
              </div>
              <div className={styles.cell}><span className={styles.empIdPill}>#{e.employeeID}</span></div>
              <div className={styles.cell}>{e.assignedLeads}</div>
              <div className={styles.cell}>{e.closedLeads}</div>
              <div className={styles.cell}>
                <span className={styles.statusActive}><span className={styles.dot} /> Active</span>
              </div>
            </div>
          ))}
        </div>
      </div>

      </div>
    </div>
  );
}
